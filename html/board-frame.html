<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />

  <!-- Chess.js с кеш-бъст и fallback -->
  <script>
    (function(){
      const version = Date.now();
      const script = document.createElement('script');
      script.src = `../libs/chess.min.js?v=${version}`;
      script.onerror = function() {
        console.warn('Локалният chess.min.js не зареди, пробвам CDN...');
        const fallback = document.createElement('script');
        fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js';
        document.head.appendChild(fallback);
      };
      document.head.appendChild(script);
    })();
  </script>

  <!-- Stockfish с кеш-бъст и fallback -->
  <script>
    (function(){
      const version = Date.now();
      const script = document.createElement('script');
      script.src = `../libs/stockfish.js?v=${version}`;
      script.onerror = function() {
        console.warn('Локалният stockfish.js не зареди, пробвам CDN...');
        const fallback = document.createElement('script');
        fallback.src = 'https://cdn.jsdelivr.net/gh/niklasf/stockfish.js/stockfish.js';
        document.head.appendChild(fallback);
      };
      document.head.appendChild(script);
    })();
  </script>

  <style>
    body {
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      color: white;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      width: 480px;
      height: 480px;
      border: 2px solid #888;
      margin-top: 20px;
    }
    .square {
      width: 60px;
      height: 60px;
    }
    .white { background: #eee; }
    .black { background: #555; }
    .square img {
      width: 100%;
      height: 100%;
    }
    #analysis {
      margin-top: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="board"></div>
  <div id="analysis">Анализът ще се появи тук</div>

  <script>
    const boardEl = document.getElementById("board");
    const analysisEl = document.getElementById("analysis");

    const pieceMap = {
      p: 'bP', r: 'bR', n: 'bN', b: 'bB', q: 'bQ', k: 'bK',
      P: 'wP', R: 'wR', N: 'wN', B: 'wB', Q: 'wQ', K: 'wK'
    };

    let game;
    let engine;

    function renderBoard(fen) {
      boardEl.innerHTML = "";
      const rows = fen.split(" ")[0].split("/");
      rows.forEach((row, rIdx) => {
        let c = 0;
        for (let ch of row) {
          const square = document.createElement("div");
          square.className = "square " + ((rIdx + c) % 2 === 0 ? "white" : "black");
          if (!isNaN(ch)) {
            c += parseInt(ch);
          } else {
            const piece = pieceMap[ch];
            const img = document.createElement("img");
            img.src = `../img/${piece}.png`;
            square.appendChild(img);
            c++;
          }
          boardEl.appendChild(square);
        }
      });
    }

    function initEngine() {
      try {
        engine = Stockfish();
        engine.onmessage = function(event) {
          const line = event.data || event;
          if (typeof line === "string" && line.includes("bestmove")) {
            const bestMove = line.split(" ")[1];
            analysisEl.textContent = "Най-добър ход: " + bestMove;
          }
          if (typeof line === "string" && line.includes("score")) {
            const scoreMatch = line.match(/score (cp|mate) (-?\d+)/);
            if (scoreMatch) {
              if (scoreMatch[1] === "cp") {
                analysisEl.textContent += " | Оценка: " + (scoreMatch[2] / 100).toFixed(2);
              } else if (scoreMatch[1] === "mate") {
                analysisEl.textContent += " | Мат след " + scoreMatch[2] + " хода";
              }
            }
          }
        };
      } catch (err) {
        analysisEl.textContent = "Stockfish не можа да се стартира.";
      }
    }

    function analyzePosition() {
      if (!engine || !game) {
        analysisEl.textContent = "Няма позиция за анализ.";
        return;
      }
      engine.postMessage("uci");
      engine.postMessage("position fen " + game.fen());
      engine.postMessage("go depth 15");
    }

    window.addEventListener('load', () => {
      if (typeof Chess === 'function') {
        game = new Chess();
        renderBoard(game.fen());
      } else {
        console.error('chess.min.js не е зареден!');
      }
      if (typeof Stockfish === 'function') {
        initEngine();
      }
    });

    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (msg.type === "loadPGN") {
        game = new Chess();
        const success = game.load_pgn(msg.data);
        if (!success) {
          alert("Невалиден PGN!");
          return;
        }
        renderBoard(game.fen());
      }
      if (msg.type === "analyzePosition") {
        analyzePosition();
      }
    });
  </script>
</body>
</html>
